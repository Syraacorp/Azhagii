<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pin2Fix - Report Issue</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f1f5f9;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
            padding: 20px;
            z-index: 1000;
        }

        .sidebar .brand {
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
        }

        .sidebar .brand i {
            margin-right: 10px;
            color: #93c5fd;
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 5px;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .sidebar .nav-link i {
            width: 25px;
        }

        .main-content {
            margin-left: 260px;
            padding: 20px 30px;
        }

        .form-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .form-control,
        .form-select {
            border-radius: 10px;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        #map {
            height: 300px;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
        }

        .btn-submit {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            color: white;
            font-weight: 600;
        }

        .severity-group {
            display: flex;
            gap: 10px;
        }

        .severity-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .severity-btn:hover {
            border-color: #3b82f6;
        }

        .severity-btn.active {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .severity-btn.s1 {
            color: #059669;
        }

        .severity-btn.s2 {
            color: #0891b2;
        }

        .severity-btn.s3 {
            color: #d97706;
        }

        .severity-btn.s4 {
            color: #dc2626;
        }

        .severity-btn.s5 {
            color: #7c2d12;
        }

        .photo-preview {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .photo-preview img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="brand"><i class="fas fa-map-marker-alt"></i> Pin2Fix</div>
        <nav class="nav flex-column">
            <a class="nav-link" th:href="@{/citizen/dashboard}"><i class="fas fa-home"></i> Dashboard</a>
            <a class="nav-link active" th:href="@{/citizen/report}"><i class="fas fa-plus-circle"></i> Report Issue</a>
            <a class="nav-link" th:href="@{/citizen/notifications}"><i class="fas fa-bell"></i> Notifications</a>
            <a class="nav-link" th:href="@{/logout}"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </nav>
    </div>

    <div class="main-content">
        <h1 class="mb-4" style="color: #1e3a8a; font-weight: 700;">
            <i class="fas fa-exclamation-triangle me-2"></i>Report an Issue
        </h1>

        <div class="form-card">
            <form th:action="@{/citizen/report}" method="post" enctype="multipart/form-data" id="reportForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Issue Title *</label>
                            <input type="text" name="title" class="form-control" placeholder="Brief title for the issue"
                                required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Description *</label>
                            <textarea name="description" class="form-control" rows="4"
                                placeholder="Detailed description of the issue" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Government Body *</label>
                            <select name="govId" class="form-select" required>
                                <option value="">Select Government Body</option>
                                <option th:each="gov : ${governmentBodies}" th:value="${gov.govId}"
                                    th:text="${gov.name}">Gov Body</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Severity Level *</label>
                            <div class="severity-group">
                                <div class="severity-btn s1" data-value="1" onclick="selectSeverity(this, 1)"><i
                                        class="fas fa-check-circle"></i><br>Low</div>
                                <div class="severity-btn s2" data-value="2" onclick="selectSeverity(this, 2)"><i
                                        class="fas fa-info-circle"></i><br>Minor</div>
                                <div class="severity-btn s3 active" data-value="3" onclick="selectSeverity(this, 3)"><i
                                        class="fas fa-exclamation-circle"></i><br>Medium</div>
                                <div class="severity-btn s4" data-value="4" onclick="selectSeverity(this, 4)"><i
                                        class="fas fa-exclamation-triangle"></i><br>High</div>
                                <div class="severity-btn s5" data-value="5" onclick="selectSeverity(this, 5)"><i
                                        class="fas fa-skull-crossbones"></i><br>Critical</div>
                            </div>
                            <input type="hidden" name="severity" id="severityInput" value="3">
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Upload Photos (Evidence)</label>
                            <input type="file" name="photos" class="form-control" accept="image/*" multiple
                                id="photoInput">
                            <div class="photo-preview" id="photoPreview"></div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Location * (Click on map or use current
                                location)</label>
                            <div id="map"></div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2"
                                onclick="getCurrentLocation()">
                                <i class="fas fa-crosshairs me-1"></i>Use My Current Location
                            </button>
                        </div>

                        <input type="hidden" name="latitude" id="latitudeInput" required>
                        <input type="hidden" name="longitude" id="longitudeInput" required>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Address</label>
                            <input type="text" name="addressText" id="addressInput" class="form-control"
                                placeholder="Address will be auto-filled or enter manually" required>
                        </div>

                        <div class="row">
                            <div class="col-6">
                                <label class="form-label text-muted">Latitude</label>
                                <input type="text" class="form-control" id="latDisplay" readonly>
                            </div>
                            <div class="col-6">
                                <label class="form-label text-muted">Longitude</label>
                                <input type="text" class="form-control" id="lngDisplay" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <div class="d-flex justify-content-between">
                    <a th:href="@{/citizen/dashboard}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Cancel
                    </a>
                    <button type="submit" class="btn btn-submit">
                        <i class="fas fa-paper-plane me-1"></i>Submit Report
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map centered on Tamil Nadu
        var map = L.map('map').setView([13.0827, 80.2707], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        var marker = null;

        function setLocation(lat, lng) {
            document.getElementById('latitudeInput').value = lat;
            document.getElementById('longitudeInput').value = lng;
            document.getElementById('latDisplay').value = lat.toFixed(8);
            document.getElementById('lngDisplay').value = lng.toFixed(8);

            if (marker) map.removeLayer(marker);
            marker = L.marker([lat, lng]).addTo(map);
            map.setView([lat, lng], 15);

            // Reverse geocode
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                .then(r => r.json())
                .then(data => {
                    if (data.display_name) {
                        document.getElementById('addressInput').value = data.display_name;
                    }
                });
        }

        map.on('click', function (e) {
            setLocation(e.latlng.lat, e.latlng.lng);
        });

        function getCurrentLocation() {
            if (navigator.geolocation) {
                Swal.fire({ title: 'Getting location...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                navigator.geolocation.getCurrentPosition(
                    function (pos) {
                        Swal.close();
                        setLocation(pos.coords.latitude, pos.coords.longitude);
                    },
                    function (err) {
                        Swal.fire({ icon: 'error', title: 'Location Error', text: 'Could not get your location. Please click on the map.' });
                    }
                );
            } else {
                Swal.fire({ icon: 'error', title: 'Not Supported', text: 'Geolocation is not supported by your browser.' });
            }
        }

        function selectSeverity(el, val) {
            document.querySelectorAll('.severity-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('severityInput').value = val;
        }

        document.getElementById('photoInput').addEventListener('change', function (e) {
            var preview = document.getElementById('photoPreview');
            preview.innerHTML = '';
            for (var file of e.target.files) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    var img = document.createElement('img');
                    img.src = e.target.result;
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('reportForm').addEventListener('submit', function (e) {
            if (!document.getElementById('latitudeInput').value || !document.getElementById('longitudeInput').value) {
                e.preventDefault();
                Swal.fire({ icon: 'warning', title: 'Location Required', text: 'Please select a location on the map or use your current location.' });
            }
        });

        // Try to get location on page load
        getCurrentLocation();
    </script>
</body>

</html>