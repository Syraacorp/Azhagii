<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Admin - Pin2Fix</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <a href="/admin/dashboard.html" class="navbar-brand">
            <i class="fas fa-map-marker-alt"></i>
            Pin2Fix - Admin
        </a>
        <ul class="navbar-nav">
            <li class="nav-user">
                <span class="user-name" id="user-name">Admin</span>
                <a href="#" onclick="Nav.logout()" class="btn btn-outline btn-sm">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </li>
        </ul>
    </nav>

    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <ul class="sidebar-nav">
                <li>
                    <a href="/admin/dashboard.html">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                </li>
                <li>
                    <a href="/admin/users.html">
                        <i class="fas fa-users"></i> Users
                    </a>
                </li>
                <li>
                    <a href="/admin/gov-bodies.html">
                        <i class="fas fa-building"></i> Gov Bodies
                    </a>
                </li>
                <li>
                    <a href="/admin/departments.html">
                        <i class="fas fa-sitemap"></i> Departments
                    </a>
                </li>
                <li>
                    <a href="/admin/issues.html">
                        <i class="fas fa-exclamation-circle"></i> All Issues
                    </a>
                </li>
                <li>
                    <a href="/admin/reports.html" class="active">
                        <i class="fas fa-chart-bar"></i> Reports
                    </a>
                </li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">Reports & Analytics</h1>
            </div>

            <!-- Summary Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="total-issues">0</h3>
                        <p>Total Issues</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="resolved-issues">0</h3>
                        <p>Resolved</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon warning">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="pending-issues">0</h3>
                        <p>Pending</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon info">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="resolution-rate">0%</h3>
                        <p>Resolution Rate</p>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Issues by Status</h2>
                    </div>
                    <div style="height: 300px;">
                        <canvas id="status-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Issues by Government Body</h2>
                    </div>
                    <div style="height: 300px;">
                        <canvas id="govbody-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Issues by Severity</h2>
                    </div>
                    <div style="height: 300px;">
                        <canvas id="severity-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Monthly Trend</h2>
                    </div>
                    <div style="height: 300px;">
                        <canvas id="trend-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Government Body Performance -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Government Body Performance</h2>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Government Body</th>
                            <th>Total Issues</th>
                            <th>Completed</th>
                            <th>In Progress</th>
                            <th>Pending</th>
                            <th>Resolution Rate</th>
                        </tr>
                    </thead>
                    <tbody id="performance-table">
                        <tr><td colspan="6" class="text-center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Top Feedback -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Average Ratings by Gov Body</h2>
                </div>
                <div id="ratings-container">
                    <p class="text-center" style="color: var(--text-light);">Loading...</p>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/app.js"></script>
    <script>
        // Auth check
        if (!AuthGuard.check(['ADMIN'])) {
            // Redirect handled by AuthGuard
        }

        let issues = [];
        let govBodies = [];
        let feedback = [];

        async function loadData() {
            try {
                const [issuesRes, govRes, feedbackRes] = await Promise.all([
                    Api.get('/issues'),
                    Api.get('/organizations/gov-bodies'),
                    Api.get('/feedback')
                ]);

                if (issuesRes.success) issues = issuesRes.data;
                if (govRes.success) govBodies = govRes.data;
                if (feedbackRes.success) feedback = feedbackRes.data;

                updateSummary();
                createStatusChart();
                createGovBodyChart();
                createSeverityChart();
                createTrendChart();
                updatePerformanceTable();
                updateRatings();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function updateSummary() {
            const total = issues.length;
            const resolved = issues.filter(i => i.status === 'COMPLETED').length;
            const pending = issues.filter(i => ['PENDING', 'FORWARDED'].includes(i.status)).length;
            const rate = total > 0 ? Math.round((resolved / total) * 100) : 0;

            document.getElementById('total-issues').textContent = total;
            document.getElementById('resolved-issues').textContent = resolved;
            document.getElementById('pending-issues').textContent = pending;
            document.getElementById('resolution-rate').textContent = rate + '%';
        }

        function createStatusChart() {
            const statusCounts = {};
            issues.forEach(i => {
                statusCounts[i.status] = (statusCounts[i.status] || 0) + 1;
            });

            const ctx = document.getElementById('status-chart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            '#f59e0b', // pending
                            '#8b5cf6', // forwarded
                            '#3b82f6', // assigned
                            '#06b6d4', // in progress
                            '#10b981', // evidence
                            '#22c55e', // approved
                            '#16a34a', // completed
                            '#ef4444', // rejected
                            '#dc2626'  // reopened
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        function createGovBodyChart() {
            const govCounts = {};
            issues.forEach(i => {
                const govBody = govBodies.find(g => g.govBodyId === i.govBodyId);
                const name = govBody ? govBody.name : 'Unassigned';
                govCounts[name] = (govCounts[name] || 0) + 1;
            });

            const ctx = document.getElementById('govbody-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(govCounts),
                    datasets: [{
                        label: 'Issues',
                        data: Object.values(govCounts),
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createSeverityChart() {
            const severityCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
            issues.forEach(i => {
                severityCounts[i.severity] = (severityCounts[i.severity] || 0) + 1;
            });

            const ctx = document.getElementById('severity-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['1 (Low)', '2', '3 (Medium)', '4', '5 (Critical)'],
                    datasets: [{
                        label: 'Issues',
                        data: Object.values(severityCounts),
                        backgroundColor: ['#22c55e', '#84cc16', '#f59e0b', '#f97316', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createTrendChart() {
            // Group issues by month
            const monthCounts = {};
            issues.forEach(i => {
                const date = new Date(i.createdAt);
                const month = date.toLocaleString('default', { month: 'short', year: 'numeric' });
                monthCounts[month] = (monthCounts[month] || 0) + 1;
            });

            // Sort by date
            const sortedMonths = Object.keys(monthCounts).sort((a, b) => {
                return new Date(a) - new Date(b);
            }).slice(-6); // Last 6 months

            const ctx = document.getElementById('trend-chart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Issues',
                        data: sortedMonths.map(m => monthCounts[m] || 0),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updatePerformanceTable() {
            const tbody = document.getElementById('performance-table');
            
            const performance = govBodies.map(gov => {
                const govIssues = issues.filter(i => i.govBodyId === gov.govBodyId);
                const total = govIssues.length;
                const completed = govIssues.filter(i => i.status === 'COMPLETED').length;
                const inProgress = govIssues.filter(i => ['IN_PROGRESS', 'EVIDENCE_SUBMITTED', 'HEAD_APPROVED'].includes(i.status)).length;
                const pending = govIssues.filter(i => ['PENDING', 'FORWARDED', 'ASSIGNED'].includes(i.status)).length;
                const rate = total > 0 ? Math.round((completed / total) * 100) : 0;

                return {
                    name: gov.name,
                    total,
                    completed,
                    inProgress,
                    pending,
                    rate
                };
            }).filter(p => p.total > 0);

            if (performance.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No data available</td></tr>';
                return;
            }

            tbody.innerHTML = performance.map(p => `
                <tr>
                    <td><strong>${p.name}</strong></td>
                    <td>${p.total}</td>
                    <td><span class="status-badge status-completed">${p.completed}</span></td>
                    <td><span class="status-badge status-in-progress">${p.inProgress}</span></td>
                    <td><span class="status-badge status-pending">${p.pending}</span></td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="flex: 1; height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden;">
                                <div style="width: ${p.rate}%; height: 100%; background: ${p.rate >= 70 ? '#22c55e' : p.rate >= 40 ? '#f59e0b' : '#ef4444'};"></div>
                            </div>
                            <span style="font-weight: 600;">${p.rate}%</span>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateRatings() {
            const container = document.getElementById('ratings-container');
            
            // Group feedback by gov body
            const ratings = {};
            feedback.forEach(f => {
                const issue = issues.find(i => i.issueId === f.issueId);
                if (issue) {
                    const gov = govBodies.find(g => g.govBodyId === issue.govBodyId);
                    if (gov) {
                        if (!ratings[gov.name]) {
                            ratings[gov.name] = { total: 0, count: 0 };
                        }
                        ratings[gov.name].total += f.rating;
                        ratings[gov.name].count++;
                    }
                }
            });

            if (Object.keys(ratings).length === 0) {
                container.innerHTML = '<p class="text-center" style="color: var(--text-light);">No feedback data available</p>';
                return;
            }

            container.innerHTML = Object.entries(ratings).map(([name, data]) => {
                const avg = (data.total / data.count).toFixed(1);
                const stars = Math.round(avg);
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
                        <span><strong>${name}</strong></span>
                        <div>
                            ${'<i class="fas fa-star" style="color: #f59e0b;"></i>'.repeat(stars)}
                            ${'<i class="far fa-star" style="color: #d1d5db;"></i>'.repeat(5 - stars)}
                            <span style="margin-left: 0.5rem; font-weight: 600;">${avg}/5</span>
                            <span style="color: var(--text-light); font-size: 0.875rem;">(${data.count} reviews)</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load data on page load
        loadData();
    </script>
</body>
</html>
