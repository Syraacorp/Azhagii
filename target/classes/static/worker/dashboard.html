<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker Dashboard - Pin2Fix</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <a href="/worker/dashboard.html" class="navbar-brand">
            <i class="fas fa-map-marker-alt"></i>
            Pin2Fix - Worker
        </a>
        <ul class="navbar-nav">
            <li>
                <a href="/worker/notifications.html" class="notification-badge">
                    <i class="fas fa-bell"></i>
                    <span class="badge" id="notification-count" style="display: none;">0</span>
                </a>
            </li>
            <li class="nav-user">
                <span class="user-name" id="user-name">Worker</span>
                <a href="#" onclick="Nav.logout()" class="btn btn-outline btn-sm">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </li>
        </ul>
    </nav>

    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <ul class="sidebar-nav">
                <li>
                    <a href="/worker/dashboard.html" class="active">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                </li>
                <li>
                    <a href="/worker/my-tasks.html">
                        <i class="fas fa-tasks"></i> My Tasks
                    </a>
                </li>
                <li>
                    <a href="/worker/notifications.html">
                        <i class="fas fa-bell"></i> Notifications
                    </a>
                </li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">My Dashboard</h1>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon warning">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="stat-assigned">0</h3>
                        <p>Assigned</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class="fas fa-spinner"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="stat-progress">0</h3>
                        <p>In Progress</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="stat-completed">0</h3>
                        <p>Completed</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon danger">
                        <i class="fas fa-redo"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="stat-reopened">0</h3>
                        <p>Reopened</p>
                    </div>
                </div>
            </div>

            <!-- Active Tasks -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">My Active Tasks</h2>
                    <a href="/worker/my-tasks.html" class="btn btn-outline btn-sm">View All</a>
                </div>
                <div id="tasks-container">
                    <!-- Tasks will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <script src="/js/app.js"></script>
    <script>
        // Auth check
        if (!AuthGuard.check(['WORKER'])) {
            // Redirect handled by AuthGuard
        }

        const user = Session.get();

        async function loadDashboard() {
            try {
                const response = await Api.get(`/assignments/assignee/${user.userId}`);
                if (response.success) {
                    const assignments = response.data;
                    updateStats(assignments);
                    displayTasks(assignments.filter(a => ['ASSIGNED', 'IN_PROGRESS', 'REOPENED'].includes(a.status)));
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function updateStats(assignments) {
            document.getElementById('stat-assigned').textContent = 
                assignments.filter(a => a.status === 'ASSIGNED').length;
            document.getElementById('stat-progress').textContent = 
                assignments.filter(a => a.status === 'IN_PROGRESS').length;
            document.getElementById('stat-completed').textContent = 
                assignments.filter(a => a.status === 'COMPLETED').length;
            document.getElementById('stat-reopened').textContent = 
                assignments.filter(a => a.status === 'REOPENED').length;
        }

        async function displayTasks(assignments) {
            const container = document.getElementById('tasks-container');
            
            if (assignments.length === 0) {
                container.innerHTML = '<p class="text-center" style="color: var(--text-light);">No active tasks</p>';
                return;
            }

            // Load issue details for each assignment
            let html = '';
            for (const assignment of assignments) {
                const issueResponse = await Api.get(`/issues/${assignment.issueId}`);
                if (issueResponse.success) {
                    const issue = issueResponse.data;
                    html += `
                        <div class="card" style="margin-bottom: 1rem; ${assignment.status === 'REOPENED' ? 'border-left: 4px solid var(--danger-color);' : ''}">
                            <div class="d-flex justify-content-between align-items-center" style="flex-wrap: wrap; gap: 1rem;">
                                <div style="flex: 1;">
                                    <div class="d-flex align-items-center gap-2">
                                        <h3 style="margin: 0;">${issue.title}</h3>
                                        <span class="status-badge ${getAssignmentStatusClass(assignment.status)}">${assignment.status}</span>
                                    </div>
                                    <p style="color: var(--text-light); margin: 0.5rem 0;">${issue.description.substring(0, 100)}...</p>
                                    <p style="color: var(--text-light); font-size: 0.875rem;">
                                        <i class="fas fa-map-marker-alt"></i> ${issue.addressText || 'No address'}
                                    </p>
                                    ${assignment.comment ? `<p style="color: var(--warning-color); font-size: 0.875rem;"><strong>Instructions:</strong> ${assignment.comment}</p>` : ''}
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline btn-sm" onclick="viewTask(${assignment.assignmentId}, ${issue.issueId})">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    ${assignment.status === 'ASSIGNED' ? `
                                        <button class="btn btn-primary btn-sm" onclick="startWork(${assignment.assignmentId})">
                                            <i class="fas fa-play"></i> Start Work
                                        </button>
                                    ` : ''}
                                    ${assignment.status === 'IN_PROGRESS' || assignment.status === 'REOPENED' ? `
                                        <button class="btn btn-success btn-sm" onclick="submitEvidence(${assignment.assignmentId})">
                                            <i class="fas fa-camera"></i> Submit Evidence
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            container.innerHTML = html;
        }

        function getAssignmentStatusClass(status) {
            const map = {
                'ASSIGNED': 'status-assigned',
                'IN_PROGRESS': 'status-in-progress',
                'COMPLETED': 'status-completed',
                'REOPENED': 'status-reopened'
            };
            return map[status] || '';
        }

        async function viewTask(assignmentId, issueId) {
            const issueResponse = await Api.get(`/issues/${issueId}`);
            const photosResponse = await Api.get(`/issues/${issueId}/photos`);
            
            let photosHtml = '<p>No photos</p>';
            if (photosResponse.success && photosResponse.data.length > 0) {
                photosHtml = photosResponse.data.map(p => `
                    <img src="${p.url}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; margin: 0.25rem;">
                `).join('');
            }

            if (issueResponse.success) {
                const issue = issueResponse.data;
                Swal.fire({
                    title: issue.title,
                    html: `
                        <div style="text-align: left;">
                            <p><strong>Description:</strong> ${issue.description}</p>
                            <p><strong>Location:</strong> ${issue.addressText || 'N/A'}</p>
                            <p><strong>Severity:</strong> ${issue.severity}/5</p>
                            <hr>
                            <h4>Evidence Photos</h4>
                            <div style="display: flex; flex-wrap: wrap;">
                                ${photosHtml}
                            </div>
                            <hr>
                            <p><a href="https://www.google.com/maps?q=${issue.latitude},${issue.longitude}" target="_blank" class="btn btn-outline btn-sm">
                                <i class="fas fa-map"></i> Open in Google Maps
                            </a></p>
                        </div>
                    `,
                    width: '600px',
                    showCloseButton: true,
                    showConfirmButton: false
                });
            }
        }

        async function startWork(assignmentId) {
            const result = await Alert.confirm('Start Work', 'Are you ready to start working on this task?');
            if (result.isConfirmed) {
                Alert.loading('Updating status...');
                try {
                    const response = await Api.put(`/assignments/${assignmentId}/status?status=IN_PROGRESS&actorId=${user.userId}`);
                    Alert.close();

                    if (response.success) {
                        Alert.success('Started!', 'Task marked as in progress.');
                        loadDashboard();
                    } else {
                        Alert.error('Error', response.message);
                    }
                } catch (error) {
                    Alert.close();
                    Alert.error('Error', 'Failed to update status');
                }
            }
        }

        async function submitEvidence(assignmentId) {
            const { value: file } = await Swal.fire({
                title: 'Submit Work Evidence',
                html: `
                    <div style="text-align: left;">
                        <p>Upload a photo showing the completed work:</p>
                        <input type="file" id="swal-file" accept="image/*" class="swal2-file" style="width: 100%; margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Notes</label>
                        <textarea id="swal-notes" class="swal2-textarea" placeholder="Describe the work done..." style="width: 100%;"></textarea>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Submit',
                confirmButtonColor: '#22c55e',
                preConfirm: () => {
                    const file = document.getElementById('swal-file').files[0];
                    const notes = document.getElementById('swal-notes').value;
                    if (!file) {
                        Swal.showValidationMessage('Please select a photo');
                        return false;
                    }
                    return { file, notes };
                }
            });

            if (file) {
                Alert.loading('Uploading evidence...');
                try {
                    const formData = new FormData();
                    formData.append('file', file.file);
                    formData.append('notes', file.notes);
                    formData.append('assignmentId', assignmentId);
                    formData.append('workerId', user.userId);

                    const response = await Api.upload('/evidence', formData);
                    Alert.close();

                    if (response.success) {
                        Alert.success('Submitted!', 'Your work evidence has been submitted for approval.');
                        loadDashboard();
                    } else {
                        Alert.error('Error', response.message);
                    }
                } catch (error) {
                    Alert.close();
                    Alert.error('Error', 'Failed to submit evidence');
                }
            }
        }

        // Load dashboard on page load
        loadDashboard();
    </script>
</body>
</html>
