<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Complaint - Pin2Fix</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <a href="/citizen/dashboard.html" class="navbar-brand">
            <i class="fas fa-map-marker-alt"></i>
            Pin2Fix
        </a>
        <ul class="navbar-nav">
            <li>
                <a href="/citizen/notifications.html" class="notification-badge">
                    <i class="fas fa-bell"></i>
                    <span class="badge" id="notification-count" style="display: none;">0</span>
                </a>
            </li>
            <li class="nav-user">
                <span class="user-name" id="user-name">User</span>
                <a href="#" onclick="Nav.logout()" class="btn btn-outline btn-sm">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </li>
        </ul>
    </nav>

    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <ul class="sidebar-nav">
                <li>
                    <a href="/citizen/dashboard.html">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                </li>
                <li>
                    <a href="/citizen/new-complaint.html" class="active">
                        <i class="fas fa-plus-circle"></i> New Complaint
                    </a>
                </li>
                <li>
                    <a href="/citizen/my-complaints.html">
                        <i class="fas fa-list"></i> My Complaints
                    </a>
                </li>
                <li>
                    <a href="/citizen/notifications.html">
                        <i class="fas fa-bell"></i> Notifications
                    </a>
                </li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">Report New Issue</h1>
            </div>

            <div class="card">
                <form id="complaintForm">
                    <div class="form-group">
                        <label class="form-label" for="title">Issue Title *</label>
                        <input type="text" id="title" class="form-control" placeholder="Brief title of the issue" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="description">Description *</label>
                        <textarea id="description" class="form-control" placeholder="Describe the issue in detail..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="severity">Severity Level</label>
                        <select id="severity" class="form-select">
                            <option value="1">1 - Low (Minor inconvenience)</option>
                            <option value="2">2 - Medium-Low</option>
                            <option value="3" selected>3 - Medium (Needs attention)</option>
                            <option value="4">4 - Medium-High</option>
                            <option value="5">5 - High (Urgent - Safety hazard)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Location * (Click on map to set location)</label>
                        <div class="map-container" id="map"></div>
                        <input type="hidden" id="latitude" required>
                        <input type="hidden" id="longitude" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="address">Address</label>
                        <input type="text" id="address" class="form-control" placeholder="Address will be auto-filled or enter manually">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Upload Evidence (Photos)</label>
                        <div class="file-upload" onclick="document.getElementById('photos').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Click to upload photos (Max 5 photos)</p>
                            <input type="file" id="photos" multiple accept="image/*" style="display: none;">
                        </div>
                        <div class="file-preview" id="photo-preview"></div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="button" onclick="getCurrentLocation()" class="btn btn-secondary">
                            <i class="fas fa-crosshairs"></i> Use Current Location
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Submit Complaint
                        </button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script src="/js/app.js"></script>
    <script>
        // Auth check
        if (!AuthGuard.check(['CITIZEN'])) {
            // Redirect handled by AuthGuard
        }

        let map;
        let marker;
        let selectedFiles = [];

        // Initialize map
        function initMap() {
            map = L.map('map').setView([20.5937, 78.9629], 5); // Default to India

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            map.on('click', function(e) {
                setLocation(e.latlng.lat, e.latlng.lng);
            });
        }

        function setLocation(lat, lng) {
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;

            if (marker) {
                marker.setLatLng([lat, lng]);
            } else {
                marker = L.marker([lat, lng]).addTo(map);
            }

            map.setView([lat, lng], 15);

            // Reverse geocoding for address
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                .then(response => response.json())
                .then(data => {
                    if (data.display_name) {
                        document.getElementById('address').value = data.display_name;
                    }
                })
                .catch(error => console.error('Geocoding error:', error));
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                Alert.loading('Getting your location...');
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        Alert.close();
                        setLocation(position.coords.latitude, position.coords.longitude);
                        Alert.success('Location Set', 'Your current location has been set.');
                    },
                    (error) => {
                        Alert.close();
                        Alert.error('Location Error', 'Unable to get your location. Please click on the map to set location.');
                    }
                );
            } else {
                Alert.error('Not Supported', 'Geolocation is not supported by your browser.');
            }
        }

        // File upload preview
        document.getElementById('photos').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (files.length + selectedFiles.length > 5) {
                Alert.warning('Limit Exceeded', 'You can only upload maximum 5 photos.');
                return;
            }

            selectedFiles = [...selectedFiles, ...files].slice(0, 5);
            updatePhotoPreview();
        });

        function updatePhotoPreview() {
            const preview = document.getElementById('photo-preview');
            preview.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.style.position = 'relative';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button type="button" onclick="removePhoto(${index})" 
                            style="position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        function removePhoto(index) {
            selectedFiles.splice(index, 1);
            updatePhotoPreview();
        }

        // Form submission
        document.getElementById('complaintForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const latitude = document.getElementById('latitude').value;
            const longitude = document.getElementById('longitude').value;

            if (!latitude || !longitude) {
                Alert.error('Location Required', 'Please set a location on the map.');
                return;
            }

            Alert.loading('Submitting complaint...');

            try {
                // Create issue
                const issueResponse = await Api.post('/issues', {
                    title: document.getElementById('title').value,
                    description: document.getElementById('description').value,
                    severity: parseInt(document.getElementById('severity').value),
                    latitude: parseFloat(latitude),
                    longitude: parseFloat(longitude),
                    addressText: document.getElementById('address').value,
                    reporterId: Session.getUserId()
                });

                if (!issueResponse.success) {
                    Alert.close();
                    Alert.error('Error', issueResponse.message);
                    return;
                }

                const issueId = issueResponse.data.issueId;

                // Upload photos
                for (const file of selectedFiles) {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('caption', 'Evidence photo');
                    await Api.upload(`/issues/${issueId}/photos`, formData);
                }

                Alert.close();
                Alert.success('Complaint Submitted!', 'Your complaint has been registered successfully.').then(() => {
                    Nav.to('/citizen/my-complaints.html');
                });

            } catch (error) {
                Alert.close();
                Alert.error('Error', 'Failed to submit complaint. Please try again.');
            }
        });

        // Initialize
        initMap();
    </script>
</body>
</html>
